# データモデル

## ユーザー系
### txn.users — ユーザー

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | ユーザー主キー |
| **public_uid** | varchar(32) | ✕ | UNIQUE | 外部公開 ID |
| **email** | varchar(255) | ✕ | UNIQUE | ログイン用メール |
| **encrypted_password** | varchar(255) | ✕ || ハッシュ |
| **role** | smallint | ✕ | ActiveHash:`0=member` `1=vendor` `2=admin` `3=affiliate` | 役割は 1 つ |
| **detail_type** | varchar(20) | ✕ | CHECK (detail_type IN ('MemberDetail','VendorDetail','AdminDetail','AffiliateDetail')) | 詳細テーブル名 (ポリモーフィック) |
| **detail_id** | bigint | ✕ | INDEX(detail_type,detail_id) | 詳細テーブル PK |
| **login_failed_count** | int | ✕ | DEFAULT 0 | 連続失敗回数 |
| **last_login_failed_at** | timestamptz | ◯ | | 最終失敗日時 |
| **password_changed_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 変更日時 |
| **password_expires_at** | timestamptz | ◯ | | 有効期限 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* role と detail_type の二重表現 → CHECK で整合性を付ける。  
`CHECK ( (role = 0 AND detail_type = 'MemberDetail') OR … )`
* `detail_type/detail_id` で **1:1 詳細テーブル** を参照し、FK の代わりに  
RDB 制約はトリガ or アプリケーションで保証します。

### txn.user_authorities — ユーザー権限

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | 行 ID |
| **user_id** | bigint | ✕ | FK→`txn.users.id` / INDEX | 対象ユーザー |
| **authority_code** | varchar(30) | ✕ | FK→`m_authorities.code` | 付与する権限 |
| grant_state | smallint | ✕ | 0 = deny / 1 = grant | 例外無効化にも対応 |
| valid_from | timestamptz | ◯ | | 有効開始（NULL=制限なし） |
| valid_to | timestamptz | ◯ | | 有効終了 |
| created_at | timestamptz | ✕ | DEFAULT now() | 追加日時 |

#### メモ

* **UNIQUE** **(user_id, authority_code)** 重複付与防止  
* *grant_state = deny* で “ロールで自動付与されたが個別に外す” も表現可能。  
* **valid_to** をセットすれば「○日だけ管理権限」など一時付与も実装できます。

### txn.member_details — 会員ユーザー詳細

| 列名 | 型 | NULL許可許可 | 制約 | 説明 |
|--|--|--|--|--|
| **user_id** | bigint | ✕ | **PK** / FK → `users.id` (`role = member`) | 会員ユーザー本人（1 : 1） |
| nickname | varchar(50) | ◯ | UNIQUE 可 | ニックネーム |
| icon_url | varchar(255) | ◯ | | プロフィールアイコン URL |
| legal_type | smallint | ✕ | ActiveHash:`0=individual` / `1=corporation` | 個人／法人 |
| legal_name | varchar(255) | ✕ | | 氏名 or 法人名 |
| legal_name_kana | varchar(255) | ◯ | | ふりがな／法人名カナ |
| birthday | date | ◯ | — | 年齢分布・世代別LTV を出す基礎<br>クエリが単純 (`EXTRACT(year FROM AGE(now(), birthday))`) |
| gender | char(1) | ◯ | ActiveHash:'M','F','O' など | 性別 |
| billing_postal_code | varchar(20) | ◯ | | 請求先 郵便番号 |
| billing_prefecture_code | char(2) | ◯ |  FK → `m_prefectures.code` / INDEX | 請求先 都道府県 |
| billing_city_code | char(5) | ✕ | FK → `m_cities.code` / INDEX | 請求先 市区町村 |
| billing_address_line | varchar(200) | ✕ | | 請求先 番地・建物名ほか |
| billing_department | varchar(100) | ◯ | | 請求先 部署 |
| billing_phone_number | varchar(30) | ◯ | | 請求先 電話番号 |
| primary_shipping_id | bigint | ◯ | FK → `shipping_addresses.id` / INDEX | デフォルトの発送先 |
| role | smallint | ✕ | ActiveHash:`4=general` | 権限（当面一般のみ） |
| **stripe_customer_id** | varchar(255) | ◯ | index | PaymentIntent で `customer` を渡すための顧客 ID。カードを保存する場合にも必須<br>初めて決済を行う際に作成される |
| **registered_affiliate_id** | bigint | ◯ | FK → users.id / INDEX | アフィリエイトから登録した場合の登録元**アフィリエイト**（`users.role = affiliate`） |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ

* アフィリエイト連携判定は `registered_affiliate_id IS NOT NULL`  
   *この列は「発番時のアフィリエイト」を永続的に保持し、注文時は orders が参照します。*  
* **顧客 ID (`stripe_customer_id`) はすべて Stripe が自動生成**（`cus_` プレフィクス）。
* **実装ポイント**
  1. 外部キー制約  
     ```sql
     ALTER TABLE member_details
       ADD CONSTRAINT fk_affiliate_user
         FOREIGN KEY (affiliate_user_id)
         REFERENCES users(id);
     ```
  1. 役割整合性（PostgreSQL CHECK 例）  
     ```sql
     ALTER TABLE member_details
     ADD CONSTRAINT chk_affiliate_role
       CHECK (
         affiliate_user_id IS NULL
         OR EXISTS (
             SELECT 1 FROM users
              WHERE id = affiliate_user_id
                AND role = 3  -- 3 = affiliate
         )
       );
     ```
  1. Rails Associations
     ```ruby
     class MemberDetail < ApplicationRecord
       belongs_to :user           # 会員本人
       belongs_to :affiliate_user, -> { where(role: :affiliate) },
                  class_name: "User", optional: true
     end
     ```

### txn.member_shipping_addresses — 会員ユーザーの送付先アドレス

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
|  **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | 送付先レコード ID |
| **member_id** | bigint | ✕ | FK → `txn.member_details.user_id` / ON DELETE CASCADE / INDEX | 会員ユーザー (member_details) |
| label | varchar(50) | ◯ | | 宛名ラベル（例 `自宅` `会社`） |
| recipient_name | varchar(100) | ✕ | | 受取人氏名／法人名 |
| postal_code | char(8) | ✕ | | 郵便番号（ハイフン可） |
| prefecture_code | char(2) | ✕ | FK → `m_prefectures.code` / INDEX | 都道府県コード |
| city | char(5) | ✕ | FK → `m_cities.code` / INDEX | 市区町村 |
| address_line | varchar(200) | ✕ | | 番地・建物名ほか |
| phone_number | varchar(20) | ◯ | | 連絡先電話 |
| **is_default** | boolean | ✕ | DEFAULT false | デフォルト送付先フラグ |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ

* **追加インデックス・制約**
   ```sql
   -- 会員ごとに「デフォルト」は最大 1 件に制限（部分 UNIQUE）
   CREATE UNIQUE INDEX uq_member_default_address
     ON txn.member_shipping_addresses (member_id)
     WHERE is_default = true;
   ```
* これにより **1 人の会員が複数の送付先を登録可能** かつ  
   **デフォルトの送付先住所は常に 0 または 1 行** に保てます。

### txn.vendor_details — 加工業者ユーザー詳細

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **user_id** | bigint | ✕ | **PK** / FK → `users.id` (`role = vendor`) | 業者ユーザー本人（1 : 1） |
| nickname | varchar(50) | ◯ | | ニックネーム |
| profile_icon_url | varchar(500) | ◯ | | プロフィール画像 |
| vendor_name | varchar(100) | ✕ | | 事業者名 |
| vendor_name_kana | varchar(100) | ◯ | | 事業者名かな |
| invoice_number | varchar(20) | ◯ | UNIQUE | 適格請求書発行事業者番号 |
| contact_person_name | varchar(80) | ✕ | | 窓口担当者 |
| contact_person_kana | varchar(80) | ◯ | | 担当者かな |
| contact_phone_number | varchar(20) | ◯ | | 担当者直通電話 |
| office_postal_code | char(8) | ◯ | | 事業所郵便番号 |
| office_prefecture_code | char(2) | ✕ | FK → `m_prefectures.code` / INDEX | 事業所都道府県コード |
| office_city | char(5) | ✕ | FK → `m_cities.code` / INDEX | 事業所市区町村 |
| office_address_line | varchar(200) | ✕ | | 事業所番地・建物名ほか |
| office_phone_number | varchar(20) | ◯ | | 代表電話 |
| bank_name | varchar(60) | ◯ | | 振込銀行名 |
| account_type | smallint | ◯ | ActiveHash:`0=普通 1=当座` | 口座種別 |
| account_number | varchar(20) | ◯ | | 口座番号 |
| account_name | varchar(100) | ◯ | | 口座名義 |
| notes | text | ◯ | | メモ |
| stripe_account_id | varchar(255) | ✕ | FK → stripe_accounts / index | Express Connected Account の ID。<br>取得後は毎リクエストの `on_behalf_of` / `transfer_data[destination]` に使用 |
| charges_enabled | boolean | ✕ | | Webhook `account.updated` で同期。入金停止などの UI 表示に利用 |
| payouts_enabled | boolean | ✕ | | Webhook `account.updated` で同期。入金停止などの UI 表示に利用 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ

* 能力・対応地域は`txn.vendor_capabilities`、`txn.vendor_service_areas`、`txn.vendor_materials` テーブルへ正規化。  
* `invoice_number` はユニークインデックスを張り重複登録を防止。  
* `deleted_flag` を使ったソフトデリートは `default_scope` または `paranoia` などで実装可能。  

### txn.vendor_capabilities ― 業者⇔加工機能

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **vendor_id** | bigint | ✕ | FK→`txn.vendor_details.user_id` / ON DELETE CASCADE / INDEX | 業者 ID |
| **capability_code** | varchar(16) | ✕ | FK→`m_process_types.code` / INDEX | 加工能力コード（例 `LASER`） |
| created_at | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 追加日時 |

#### メモ

* *複合プライマリキー：同一業者 × 同一加工能力 の重複を禁止*  
   `PRIMARY KEY (vendor_id, capability_code)`  
  
### txn.vendor_service_areas ― 業者⇔対応地域

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **vendor_id** | bigint | ✕ | FK→`txn.vendor_details.user_id` / ON DELETE CASCADE / INDEX | 業者 ID |
| **prefecture_code** | char(2) | ✕ | FK→`m_prefectures.code` / INDEX | 対応都道府県コード (`13`=東京) |
| **city_code** | char(5) | ✕ | FK→`m_cities.code` / INDEX | 対応市区町村コード |
| created_at | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 追加日時 |

#### メモ

* `PRIMARY KEY (vendor_id, prefecture_code, city_code)`  
   *複合 PK* : `city_code` が NULL の行 (都道府県単位対応) はフロント側で制御し、NULLにならないようにする  
* 検索最適化：都道府県で業者一覧を取るクエリが多い場合 → 現段階では実装しない
   ```sql
   CREATE INDEX idx_vendor_service_areas_pref
             ON txn.vendor_service_areas (prefecture_code, vendor_id);
   ```
   **検索例** *「レーザー加工ができて東京都対応の業者を探す」*  
   ```sql
   SELECT v.*
     FROM txn.vendor_details v
     JOIN txn.vendor_capabilities  c ON c.vendor_id  = v.user_id AND c.capability_code = 'LASER'
     JOIN txn.vendor_service_areas s ON s.vendor_id  = v.user_id AND s.prefecture_code = '13';
   ```

### txn.vendor_materials ― 業者⇔対応材質

| 列名 | 型 | NULL許可 | 制約・IDX | 説明 |
| -- | -- | -- | -- | -- |
| **vendor_id** | bigint | ✕ | FK→`txn.vendor_details.user_id` ON DELETE CASCADE | 業者 |
| **material_code** | varchar(16) | ✕ | FK→`m_materials.code` | 材質コード (SUS304 等) |
| created_at | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 登録日時 |

#### メモ  

* *複合プライマリキー：同一業者 × 対応材質 の重複を禁止*  
   `PRIMARY KEY (vendor_id, material_code)`  
* **業者リストアップ用の SQL イメージ**
   ```sql
   /* ❶ この見積の加工仕様 ＋ 送付先 */
   WITH spec AS (
     SELECT qi.material_code, qi.processing_method_code,
            q.ship_prefecture_code
       FROM txn.quote_items   qi
       JOIN txn.quotes        q ON q.id = qi.quote_id
      WHERE q.id = :quote_id
   )

   /* ❷ 条件をすべて満たす業者を抽出 */
   SELECT vd.user_id
     FROM txn.vendor_details vd
     -- 加工方法
     JOIN txn.vendor_capabilities vc
          ON vc.vendor_id = vd.user_id
     -- 材質
     JOIN txn.vendor_materials    vm
          ON vm.vendor_id = vd.user_id
     -- 対応地域（都道府県単位）
     JOIN txn.vendor_service_areas vs
          ON vs.vendor_id = vd.user_id
     WHERE vc.capability_code       IN (SELECT processing_method_code FROM spec)
       AND vm.material_code         IN (SELECT material_code            FROM spec)
       AND vs.prefecture_code       =  (SELECT ship_prefecture_code     FROM spec LIMIT 1)
   GROUP BY vd.user_id
   HAVING COUNT(DISTINCT vc.capability_code) = (SELECT COUNT(DISTINCT processing_method_code) FROM spec)
      AND COUNT(DISTINCT vm.material_code)   = (SELECT COUNT(DISTINCT material_code)            FROM spec);
   ```

### txn.affiliate_details — アフィリエイトユーザー詳細

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
|--|--|--|--|--|
| **user_id** | bigint | ✕ | **PK** / FK → `users.id` (`role = affiliate`) | アフィリエイトユーザー本人（1 : 1） |
| name | varchar(100) | ✕ | | 氏名／法人名 |
| name_kana | varchar(255) | ◯ | | 氏名／法人名ふりがな |
| postal_code | char(8) | ✕ | | 郵便番号（ハイフン可） |
| prefecture_code | char(2) | ✕ | FK → `m_prefectures.code` | 都道府県コード |
| city | char(5) | ✕ | FK → `m_cities.code` | 市区町村 |
| address_line | varchar(200) | ✕ | | 番地・建物名ほか |
| phone_number | varchar(30) | ◯ | | 電話番号 |
| invoice_number | varchar(20) | ◯ | UNIQUE | 適格請求書発行事業者番号 |
| bank_name | varchar(100) | ◯ | | 振込銀行名 |
| account_type | smallint | ◯ | ActiveHash:`0=普通` `1=当座` | 口座種別（普通／当座など） |
| account_number | varchar(30) | ◯ | | 口座番号 |
| account_holder | varchar(100) | ◯ | | 口座名義 |
| **commission_rate** | decimal(5,2) | ✕ | DEFAULT 3.00 | 報酬率（%）<br>将来 2 % / 5 % などプラン差を付ける場合に備える |
| **payout_threshold** | decimal(18,4) | ✕ | DEFAULT 5000 | 支払い実行の下限額（円） |
| **unpaid_balance** | decimal(18,4) | ✕ | DEFAULT 0 | 未払い残高（金額が閾値を超えたら一括振込） |
| **last_paid_at** | timestamptz | ◯ | | 最終支払完了日時 |
| stripe_account_id | varchar(255) | ✕ | FK → stripe_accounts / index | Express Connected Account の ID。<br>取得後は毎リクエストの `on_behalf_of` / `transfer_data[destination]` に使用 |
| charges_enabled | boolean | ✕ | | Webhook `account.updated` で同期。入金停止などの UI 表示に利用 |
| payouts_enabled | boolean | ✕ | | Webhook `account.updated` で同期。入金停止などの UI 表示に利用 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### txn.admin_details — 管理ユーザー詳細

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **user_id** | bigint | ✕ | **PK** / FK → `users.id` (`role = admin`) | 管理者本人（ユーザーと 1 : 1） |
| nickname | varchar(50) | ◯ | UNIQUE 可 | 管理画面・ログ表示用ニックネーム |
| icon_url | varchar(255) | ◯ | — | プロフィールアイコンの URL |
| department | varchar(100) | ◯ | — | 所属部門・チーム名 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

## 取引系 (アプリ内部)

### txn.quotes — 見積依頼（会員カート）ヘッダ

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | 見積依頼を一意に識別 |
| **user_id** | bigint | ✕ | FK → users.id / INDEX | 依頼者（会員ユーザー） |
| **status** | smallint | ✕ | ActiveHash:`0=draft` `1=sent` `2=closed` / DEFAULT 0 | 見積全体の状態 |
| **shipping_address_id** | bigint | ✕ | FK→`txn.member_shipping_addresses.id` <br>ON UPDATE CASCADE / ON DELETE RESTRICT <br>INDEX | 依頼時点で選択した送付先 |
| **ship_prefecture_code** | char(2) | ✕ | DEFAULT '' | 検索高速化用スナップショット<br>（`shipping_address_id` 変更トリガで自動更新） |
| **ship_city_code** | char(5) | ◯ | | 同上：市区町村コード |
| **global_requirements** | text | ◯ | — | 仕上げ・公差など依頼全体の条件 |
| **deadline** | date | ◯ | — | 希望納期 |
| **remarks** | text | ◯ | — | 備考メモ |
| **accepted_request_id** | bigint | ◯ | FK → `txn.quote_requests.id` / UNIQUE | 採用した業者回答を示す送付状 ID<br>NULL許可 = 未採用 |
| **accepted_at** | timestamptz | ◯ | — | 採用確定日時 |
| **total_estimate** | decimal(18,4) | ✕ | DEFAULT 0 | 採用業者の見積合計金額 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* `accepted_request_id` にトリガで 「同じ quote_id を持つ行のみ可」 を強制する SQL をつけるか、  
アプリケーション側バリデーションを実装する。  
* `total_estimate` と `accepted_at` は `accepted_request_id` を**設定したタイミングで同時に更新する**のが推奨です。  
* `accepted_request_id` がセットされたら `quotes.status` は `closed` など**明示的に確定状態へ**。  
* *検索は `WHERE ship_prefecture_code = '13'` のようにスナップショット列で行い、*  
*詳細表示や帳票では `shipping_address_id` を JOIN して完全住所を取得。*  

### txn.quote_items ― 見積依頼（会員カート）明細

| 列名 | 型 | NULL | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint (AI) | ✕ | **PK** | 明細行 ID |
| quote_id | bigint | ✕ | FK → `txn.quotes.id` / INDEX | 親見積ヘッダ |
| line_no | smallint | ✕ | | 行番号（1 ,2 ,3…） |
| material_category_code | char(6) | ✕ | FK→`m_material_categories.code` | 材質カテゴリ（WOOD / METAL …） |
| material_code | char(16) | ✕ | FK→`m_materials.code` | 材質（樹種など） |
| shape_code | char(8) | ✕ | FK→`m_shapes.code` | 平面形状（四角形など） |
| paint_type_code | char(4) | ◯ | FK→`m_paint_types.code` | 塗装種類 (選択なし・ウレタン・自然塗装…) |
| thickness_mm | decimal(8,2) | ✕ | CHECK > 0 | 厚み |
| width1_mm | decimal(8,2) | ✕ | CHECK > 0 | 巾１ |
| width2_mm | decimal(8,2) | ◯ | CHECK > 0 | 巾２（斜辺付き形状で使用） |
| length_mm | decimal(8,2) | ✕ | CHECK > 0 | 長さ |
| **shape\_json** | jsonb | ◯ | DEFAULT '{}'::jsonb | 加工設定を集約 |
| **corner\_proc\_json** | jsonb | ◯ | **GIN** INDEX / DEFAULT '{}'::jsonb | コーナー(角)加工を集約 |
| **hole\_json** | jsonb | ◯ | **GIN** INDEX / DEFAULT '{}'::jsonb | 丸穴加工を集約 |
| **sqhole\_json** | jsonb | ◯ | **GIN** INDEX / DEFAULT '{}'::jsonb | 四角穴加工を集約 |
| **edge\_json** | jsonb | ◯ | DEFAULT '{}'::jsonb | 断面加工を集約 |
| **paint\_json** | jsonb | ◯ | DEFAULT '{}'::jsonb | 塗装状態を集約 |
| quantity | integer | ✕ | CHECK > 0 | 枚数 |
| note | text | ◯ | | 備考 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* *どんな材料が何枚必要か を会員が登録するテーブル。*  
* UI は **“カート” ＝ quote_items** と考えると実装しやすい。  
* **UNIQUE (quote_id, line_no)** で同じ見積ヘッダ内の行番号重複を防止。
* 材積・重量はアプリで自動計算とする。  
* 加工関連はjsonで集約  
  * **shape\_json**：加工設定  
     例：`{"tl":3,"tr":0,"bl":5,"br":0}`  
  * **corner\_proc\_json**：コーナー(角)加工  
     例：`{ "tl":{ "proc":"ROUND", "dx":10,"dy":10,"r":5 }, "tr":{"proc":"NONE"}, "bl":{"proc":"CHAMFER","dx":5,"dy":5,"r":0}, "br":{"proc":"NONE"} }`  
     **proc** = 加工区分 (`m_corner_processes.code`)  
     **dx/dy/r** = 縦/横/半径
  * **hole\_json**：丸穴加工  
     例：`{"tl":{"flag":true,"dy":10,"dx":15,"dia":6},…}`  
     **flag** = 丸穴加工 あり / なし (`true` / `false`)  
     **dy** = 丸穴中心までの縦距離  
     **dx** = 丸穴中心までの横距離  
     **dia** = 丸穴直径 (`m_hole_diameters.code`)
  * **sqhole\_json**：四角穴加工  
     例：`{"bl":{"flag":true,"dy":20,"dx":25,"h":10,"w":8},…}`  
  * **edge\_json**：断面加工  
     例：`{"t":"BEVEL","b":"NONE",…}`  
     `tl`/ `t`/ `tr` / `l` / `r` / `bl` / `b` / `br` = `m_edge_processes.code`  
  * **paint\_json**：塗装状態  
     例：`{"surface":"NOMAL", "color":"LT", "finish":"OPEN", "gloss":"ALL"}`  
     surface：`m_paint_surfaces` 塗装面 (標準 / 全面)  
     color：`m_paint_colors` 塗装色 (クリアー・ライト…)  
     finish：`m_grain_finishes` 木目・導管の見え方 (セミ OP / CL …)  
     gloss：`m_glosses` ツヤ (3 分・5 分・全ツヤ)  

* **JSON 内値とマスタ行（コード）の関連付け**  
   1. **一時的にラベルが欲しい場合（ビュー）**  
      ```sql
      CREATE VIEW vw_quote_item_corner AS
      SELECT qi.id,
             cps_tl.name_ja AS corner_tl_label,
             (qi.corner_proc_json->'tl'->>'r')::numeric AS radius_tl
      FROM   txn.quote_items qi
      LEFT JOIN m_corner_processes cps_tl
             ON cps_tl.code = qi.corner_proc_json->'tl'->>'proc';
      ```
   1. **頻繁に参照するなら 生成列＋外部キーも可**  
      ```sql
      ALTER TABLE txn.quote_items
        ADD COLUMN corner_tl_proc char(4)
          GENERATED ALWAYS AS
            (corner_proc_json->'tl'->>'proc') STORED;

      ALTER TABLE txn.quote_items
        ADD CONSTRAINT fk_corner_tl_proc
        FOREIGN KEY (corner_tl_proc)
        REFERENCES m_corner_processes(code);
      ```

### txn.quote_requests — 加工業者別見積ヘッダ

| 列名 | 型 | NULL許可 | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | |
| quote_id | bigint | ✕ | FK → `txn.quotes.id` / **UNIQUE¹** / INDEX | 親見積依頼 |
| vendor_id | bigint | ✕ | FK → `users.id` (`role = vendor`) / **UNIQUE¹** / INDEX | 業者ユーザー |
| status | smallint | ✕ | ActiveHash:`0=sent 1=answered 2=rejected 3=expired` / DEFAULT 0 | この業者への個別ステータス |
| **items_subtotal** | decimal(18,4) | ✕ | DEFAULT 0 | 明細小計（`txn.quote_request_items.amount` **の合計**） |
| **shipping_fee** | decimal(18,4) | ✕ | DEFAULT 0 | 送料（運賃・梱包料を含む） |
| **tax_rate_pct** | numeric(4,2) | ✕ | DEFAULT **10.00** | 適用消費税率（％）<br>例 : 10.00 / 8.00 |
| **tax_amount** | decimal(18,4) | ✕ | DEFAULT 0 | 消費税額（items_subtotal + shipping_fee に税率を掛けた値） |
| **total_estimate** | decimal(18,4) | ✕ | DEFAULT 0 | 見積合計＝ items_subtotal + shipping_fee + tax_amount |
| answered_at | timestamptz | ◯ | — | 業者回答受信日時 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

`¹ UNIQUE(quote_id, vendor_id)  -- 同一業者の重複見積を禁止`

#### メモ

* **計算フロー**  
   1. **各明細行**  
      *モデル／SQL* で  
   `amount = quantity * unit_price`（端数処理：円未満切り捨て／四捨五入を統一）  
   2. **小計**(`items_subtotal`)  
      ```sql
      SELECT SUM(amount) FROM quote_request_items
       WHERE quote_request_id = :id;
      ```  
      Rails 例
      ```ruby
      self.items_subtotal = quote_request_items.sum('quantity * unit_price')
      ```  
   3. **送料・消費税 → 合計**  
      ```ruby
      self.tax_amount     = ((items_subtotal + shipping_fee) *
                             tax_rate_pct / 100.0).round  # or floor
      self.total_estimate = items_subtotal + shipping_fee + tax_amount
      ```  
  
* **運用上のポイント**  
   | 項目 | 内容 |
   | -- | -- |
   | **再計算タイミング** | 明細を追加/変更/削除・送料入力・税率変更のたびに `recalc_totals!` を呼ぶ |
   | **DB 一貫性** | 重要処理では **DB トランザクション内で SUM → UPDATE** すると同期ズレ防止 |
   | **割引・手数料** | 必要なら `discount_amount` や `handling_fee` 列を追加し、合計算式に組み込む |
   | **端数処理ルール** | 「行単価×数量 → 円未満切り捨て」「税額は合計×税率を四捨五入」などを仕様書で明示 |

### txn.quote_request_items — 加工業者別見積明細

| 列名 | 型 | NULL許可 | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| id | bigint | ✕ | **PK / AUTO_INCREMENT** | |
| quote_request_id | bigint | ✕ | FK → `txn.quote_requests.id` / **UNIQUE¹** / INDEX | 紐づく送付状 |
| quote_item_id | bigint | ✕ | FK → `txn.quote_items.id` / **UNIQUE¹** / INDEX | 会員側ベース明細を参照 |
| unit_price | decimal(18,4) | ✕ | DEFAULT 0 | 業者回答の行単価 |
| amount | decimal(18,4) | ✕ | DEFAULT 0 / `GENERATED ALWAYS AS (unit_price * quantity)` / CHECK ≥0 | 	小計 (`unit_price × quantity`) |
| memo | text | ◯ | — | 加工可否コメント・注意点など |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

`¹ UNIQUE(quote_request_id, quote_item_id)  -- 重複行の登録を禁止`

### txn.orders — 発注ヘッダ（order_items を持たないミニマム設計）

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | 発注レコード ID |
| **quote_id** | bigint | ✕ | FK → `txn.quotes.id` | 元となる見積依頼 |
| **quote_request_id** | bigint | ◯ | UNIQUE<br>FK → `txn.quote_requests.id` <br>**ON DELETE SET NULL** | 採用した業者回答 <br>※回答が削除されても発注は残す |
| **user_id** | bigint | ✕ | FK → `txn.users.id` | 発注者（会員ユーザー） |
| **vendor_id** | bigint | ✕ | FK → `txn.users.id` | 受注業者ユーザー |
| **affiliate_id** | bigint | ◯ | FK → `txn.users.id` / INDEX | 発注者の登録元**アフィリエイト**（`users.role = affiliate`） |
| **status** | smallint | ✕ | ActiveHash:`0=pending 1=paid 2=in_production 3=shipped 4=delivered 5=cancelled`<br>DEFAULT 0 | |
| **total_amount** | decimal(18,4) | ✕ | DEFAULT 0 | 発注金額（税込） |
| **shipping_address_id** | bigint | ✕ | FK→`txn.member_shipping_addresses.id` <br>ON UPDATE CASCADE / ON DELETE RESTRICT <br>INDEX | 依頼時点で選択した送付先 |
| **paid_at** | timestamptz | ◯ | | 決済完了日時 |
| **shipped_at** | timestamptz | ◯ | | 出荷日時 |
| **delivered_at** | timestamptz | ◯ | | 納品完了日時 |
| **shipping_tracking_no** | varchar(50) | ◯ | | 追跡番号 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ

* **order_items は存在しない**ため、行単位の在庫・出荷・分析が不要なかぎりこのヘッダだけで発注業務を完結できます。  
将来必要になった際は `order_items` を追加し、`quote_request` の明細情報をバックフィルすれば安全に拡張可能です。  
* `quote_request_id` が UNIQUE なので、一つの送付状からは発注が 1 回だけ生成される設計です（見積 1 件 → 発注最大 1 件）。  
* 金額・数量に関する詳細はすべて採用した `quote_request`／`quote_items` を JOIN して参照できます。

## 取引系 (外部連携)

### txn.stripe_accounts — Express Connected Account の ID

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **user_id** | bigint | ✕ | **PK** / FK → `users.id` | ユーザー本人（1 : 1） |
| **stripe_account_id** | varchar(255) | ✕ | index | Express Connected Account の ID。<br>取得後は毎リクエストの `on_behalf_of` / `transfer_data[destination]` に使用 |
| **charges_enabled** | boolean | ✕ | | Webhook `account.updated` で同期。入金停止などの UI 表示に利用 |
| **payouts_enabled** | boolean | ✕ | | Webhook `account.updated` で同期。入金停止などの UI 表示に利用 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### txn.stripe_payments — 取引追跡

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | 取引追跡を一意に識別 |
| **order_id** | bigint | ✕ | FK → `txn.orders.id` / UNIQUE | 元となる発注ヘッダ |
| **payment_intent_id** | varchar(255) | ✕ | UNIQUE | 決済ライフサイクルの主キー |
| **charge_id** | varchar(255) | ✕ | | Destination Charge で生成される `charge` |
| **transfer_id** | varchar(255) | ✕ | | 売上が自動転送された `transfer`<br>（Destination の場合 1 件） |
| **application_fee_id** | varchar(255) | ✕ | | `application_fee_amount` を指定すると作られる Fee オブジェクト |
| **amount** | decimal(18,4) | ✕ | DEFAULT 0 | 取引総額 |
| **currency** | char(3) | ✕ | | 通貨　`ISO-4217` 3 桁（当面は固定：JPY） |
| **platform_fee** | decimal(18,4) | ✕ | DEFAULT 0 | 自社取り分の計算結果を保存 |
| **net_amount** | decimal(18,4) | ✕ | DEFAULT 0 | 加盟店取り分の計算結果を保存 |
| **status** | varchar(32) | ✕ | | `requires_payment_method` / `succeeded` など PaymentIntent の状態 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id / INDEX | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id / INDEX | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### txn.stripe_events — Webhook の冪等性

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **event_id** | varchar(255) | ✕ | **PK** | 例: `"evt_1Pn..."` |
| **account_id** | varchar(255) | ✕ | | Platform か Connected Account かを識別 |
| **type** | varchar(64) | ✕ | | `payment_intent.succeeded` など |
| **payload** | jsonb | ✕ | | まるごと保存 |
| **received_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | Webhook 受信時刻 |
| **processed_at** | timestamptz | ◯ | | 処理完了時刻（NULL → 未処理） |
| **status** | varchar(16) | ◯ | | `ok` / `error` など処理結果 |

#### メモ

* Stripe Webhook は **HTTP POST でプッシュ**されるだけ。
* 最大 3 回の再送に備え、`event_id` を主キーにした **INSERT-ベースの冪等化**を入れる。
* Rails では 1 つのコントローラを公開し、**署名検証 → DB ログ → 非同期ジョブ**というパターンが実績豊富です。
* **Rails 実装のイメージ**
   ```ruby
   # config/routes.rb
   post '/webhooks/stripe', to: 'stripe_webhooks#receive'

   # app/controllers/stripe_webhooks_controller.rb
   class StripeWebhooksController < ApplicationController
     skip_before_action :verify_authenticity_token

     def receive
       payload = request.raw_post
       sig     = request.headers['Stripe-Signature']

       event = Stripe::Webhook.construct_event(
         payload, sig, ENV['STRIPE_WEBHOOK_SECRET']
       )

       StripeEvent.transaction do
         # ↓ event_id PRIMARY KEY なので、重複なら例外 → rescue で無視
         StripeEvent.create!(event_id: event.id,
                             account_id: event.account,
                             type: event.type,
                             payload: event.data.to_json)

         BusinessLogic.call(event)   # 決済確定・振込などドメイン処理
       end

       head :ok
     rescue Stripe::SignatureVerificationError
       head :bad_request
     rescue ActiveRecord::RecordNotUnique
       head :ok  # 既に処理済み → 200 を返して再送停止
     end
   end
   ```
* **ポイント**
   > テーブルは完全に汎用ログ なので **モデル固有の payments / refunds と切り離しておく** ほうが扱いやすいです。

### txn.stripe_refunds — 返金

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **refund_id** | varchar(255) | ✕ | **PK** | 例: `re_...` |
| **payment_intent_id** | varchar(255) | ✕ | FK → `stripe_payments.payment_intent_id` / ON DELETE CASCADE / INDEX | 紐付く取引 |
| **amount** | decimal(18,4) | ✕ | DEFAULT 0 | 単位：最小通貨 |
| **status** | varchar(16) | ✕ | | `pending` / `succeeded` / `failed` |
| **reason** | varchar(32) | ✕ | | `requested_by_customer` など |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### txn.stripe_payouts — 振込

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **payout_id** | varchar(255) | ✕ | **PK** | 例: `po_...` |
| **stripe_account_id** | varchar(255) | ✕ | FK → `stripe_accounts.stripe_account_id` | どの接続先か |
| **amount** | decimal(18,4) | ✕ | DEFAULT 0 | 単位：最小通貨 |
| **arrival_date** | date | ✕ | | 銀行着金予定 |
| **status** | varchar(16) | ✕ | | `paid` / `failed` / `in_transit` |
| **failure_code** | varchar(32) | ◯ | | 失敗理由 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

## 投稿・チャット・評価系

### txn.order_reviews — 発注（orders）に対するレビュー

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | レビュー行識別 |
| **order_id** | bigint | ✕ | FK → `txn.orders.id` / UNIQUE | 対象発注ヘッダ<br>※1 注文につきレビューは 1 つまで |
| **reviewer_id** | bigint | ✕ | FK → `users.id` / INDEX | レビュー投稿者（= 発注者） |
| **vendor_id** | bigint | ✕ | FK → `users.id` (`role = vendor`) / INDEX | 対象業者<br>（`orders.vendor_id` と同一） |
| **rating** | smallint | ✕ | 1-5 範囲 CHECK | 5 段階評価 |
| **title** | varchar(100) | ◯ | — | レビュー件名 |
| **comment** | text | ◯ | — | 本文 |
| **vendor_reply** | text | ◯ | — | 業者からの返信 |
| **replied_at** | timestamptz | ◯ | — | 返信日時 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ

* **補足・運用ルール**  
  | トピック | 内容 |
  | -- | -- |
  | **投稿タイミング** | `orders.status = delivered` 以降のみ許可（ソフトバリデーション／DB TRIGGER で保証） |
  | **一意制約** | `UNIQUE(order_id)` により“同じ注文に複数レビュー”を防止 |
  | **評価スコア集計** | 1. `vendors.average_rating` をキャッシュ列として持たせる<br>2. ビューで `AVG(rating)` 集計 **← こちらを採用する** |
  | **返信権限** | `vendor_reply` / `replied_at` は対象業者ユーザーだけが更新できるようコントローラ側で制御 |
  | **検索パフォーマンス** | よく使う条件（`vendor_id`, `rating >= 4`, `created_at BETWEEN …`）に合わせて複合 INDEX を追加 |
* このテーブルで **注文完了後の顧客評価 + 業者返信** を一元管理でき、  
今後「運営による非表示」「通報フラグ」などが必要になれば `visibility_flag` や `report_count` カラムを追加して拡張できます。

### txn.articles — 投稿記事ヘッダ

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| id | bigint | ✕ | **PK** / AUTO_INCREMENT | 投稿記事 ID |
| author_type | varchar(20) | ✕ | CHECK IN ('User','Vendor','Admin','Affiliate') | 投稿主体（ポリモーフィック） |
| author_id | bigint | ✕ | INDEX(author_type, author_id) | 投稿者 ID |
| category | smallint | ✕ | ActiveHash:`0=experience` `1=notice` `2=blog` … | 記事カテゴリ |
| title | varchar(150) | ✕ | — | タイトル |
| content_blocks | **jsonb** | ✕ | DEFAULT '{}' / GIN INDEX | ブロック JSON 本文（画像・動画・注文カードなどを記述） |
| order_id | bigint | ◯ | FK → txn.orders.id / INDEX | 紐づく注文（購入体験記事など任意） |
| **likes_count** | integer | ✕ | DEFAULT 0 | いいね数（TRIGGER／counter_cache で更新） |
| **replies_count** | integer | ✕ | DEFAULT 0 | 返信数（同上） |
| **views_count** | integer | ✕ | DEFAULT 0 | 閲覧数（ビュー取得時に `UPDATE … SET views_count = views_count + 1`） |
| published_at | timestamptz | ◯ | — | 公開日時 |
| is_draft | boolean | ✕ | DEFAULT false | 下書きフラグ |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ

* **閲覧数 (`views_count`) 更新方法**
  1. 直接 UPDATE (PV/秒 < 50)
     ```sql
     UPDATE txn.articles
     SET views_count = views_count + 1
     WHERE id = :article_id;
     ```
  1. Redis バッファ → FLUSH (PV/秒 > 50) **※こちらを常時採用**  
     * 閲覧時（アプリ層）
        ```ruby
           redis.incr "article:views:#{article_id}"
        ```
        *インメモリなので超高速 & 行ロックなし*  
  （TTL 30 min などを付ければ自然にキーが減る）  
     * Sidekiq / Cron ジョブ（10 秒おき）
        ```ruby
        redis.scan_each(match: "article:views:*") do |key|
          aid      = key.split(":").last
          delta    = redis.getdel(key).to_i      # 取り出して0に戻す
          next if delta.zero?
          Article.where(id: aid)
                 .update_all("views_count = views_count + #{delta}")
        end
        ```
        *10 秒ごとにまとめて加算 ⇒ DB UPDATE 量が最大1/100〜1/1000になる*

### txn.article_media — 画像 / 動画ファイル

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
|  **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | |
| article_id | bigint | ✕ | FK → txn.articles.id / INDEX | 親記事 |
| media_type | smallint | ✕ | ActiveHash:`0=image` `1=video` | 媒体種別 |
| file_url | varchar(500) | ✕ | — | S3 等の絶対 URL |
| caption | varchar(150) | ◯ | — | キャプション／代替テキスト |
| position | smallint | ◯ | — | 表示順 |
| meta_json | jsonb | ◯ | — | 画像サイズ、video poster など |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### txn.article_likes — いいね

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | |
| article_id | bigint | ✕ | FK → txn.articles.id  / UNIQUE¹ / INDEX | 対象記事 |
| user_id | bigint | ✕ | FK → users.id  / UNIQUE¹ / INDEX | いいねしたユーザー |
| created_at | timestamptz | ✕ | — | いいね日時 |

#### メモ

* **¹UNIQUE(article_id, user_id)** 同ユーザーの重複いいね防止
* AFTER INSERT/DELETE TRIGGER で `articles.likes_count` を同期。

### txn.article_comments — 投稿記事のスレッド型返信（ブロック埋め込み不可）

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | |
| article_id | bigint | ✕ | FK → txn.articles.id / INDEX | 親記事 |
| parent_id | bigint | ◯ | FK → txn.article_comments.id / INDEX | 親コメント（NULL＝第1階層） |
| author_type | varchar(20) | ✕ | CHECK IN ('User','Vendor','Admin','Affiliate') | 投稿者種別 |
| author_id | bigint | ✕ | INDEX(author_type, author_id) | 投稿者 ID |
| body | text | ✕ | — | プレーン / Markdown Lite（メディア埋め込み禁止） |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* AFTER INSERT/DELETE トリガで `articles.replies_count` を更新。  
* 最大 1 階層は UI バリデーションで担保

### txn.quote_request_comments — 業者別見積のスレッド型返信（ブロック埋め込み不可）

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | |
| quote_request_id | bigint | ✕ | FK → txn.quote_requests.id / INDEX | 親見積 |
| parent_id | bigint | ◯ | FK → txn.quote_request_comments.id / INDEX | 親コメント（NULL＝第1階層） |
| author_type | varchar(20) | ✕ | CHECK IN ('User','Vendor','Admin','Affiliate') | 投稿者種別 |
| author_id | bigint | ✕ | INDEX(author_type, author_id) | 投稿者 ID |
| body | text | ✕ | — | プレーン / Markdown Lite（メディア埋め込み禁止） |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* 最大 1 階層は UI バリデーションで担保

## アフィリエイト系

### txn.affiliate_commissions （アフィリエイト：報酬計算専用テーブル）

| 列名 | 型 | NULL許可 | 制約 | 説明 |
|--|--|--|--|--|
| id | bigint | ✕ | PK / AUTO_INCREMENT | 報酬レコード識別子 |
| affiliate_user_id | bigint | ✕ | FK → `users.id`（role = affiliate）<br>INDEX | 報酬を受け取るアフィリエイトユーザー |
| referred_user_id | bigint | ✕ | FK → `users.id`（role = member） | クリック経由で登録したユーザー（1 人 1 行） |
| order_id | bigint | ✕ | FK → `txn.orders.id`<br>UNIQUE | 購入注文 |
| order_amount | decimal(18,4) | ✕ | DEFAULT 0 | 購入額（税込） |
| rate_pct | numeric(5,2) | ✕ | DEFAULT commission_rate | 報酬確定時料率 |
| commission_amount | decimal(18,4) | ✕ | CHECK ≥0 / DEFAULT 0 | 報酬額（通常 `order_amount × commission_rate`） |
| paid_flag | boolean | ✕ | DEFAULT false | 報酬が支払済みかどうか |
| paid_at | timestamptz | ◯ | — | 支払完了日時 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* **目的：**  
  支払対象になった「登録 ➜ 購入」だけを最小情報で保持  
  クリックや登録が成果につながらなかった場合は残しません。  
  こうしておくと、請求・会計バッチで扱う行数が少なく済みます。  
* `paid_flag` が true のとき `paid_at` を NOT NULL にする CHECK を追加  
* **計算フロー例**  
   1. **注文確定** (`orders.status = 'completed'`)  
      `affiliate_user_id IS NOT NULL` の行をバッチで抽出  
   1. **commission_amount = order_amount × rate_pct**  
      挿入：`txn.affiliate_commissions`  
   1. **支払バッチ**  
      `paid_flag=false AND affiliate_user_id = ?` を集計し、振込後 `paid_flag=true, paid_at=now()` を更新

### txn.affiliate_signups （アフィリエイト：登録ログ）

| 列名 | 型 | NULL許可 | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | ログ行 ID |
| affiliate_user_id | bigint | ✕ | FK→users.id (`affiliate`) / INDEX | 紹介元 |
| affiliate_click_id | bigint | ◯ | FK→h_affiliate_clicks.id / INDEX | 元クリック |
| signup_user_id | bigint | ✕ | FK→users.id (`member`) / **UNIQUE** | 登録ユーザー |
| signup_at | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 登録日時 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 (= signup_at) |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* **👆 報酬確定処理は**  
  affiliate_signups + 「初回注文」トリガーで合致を検出し affiliate_commissions へ INSERT。

### 8.17 txn.payouts 振込ログ

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | 振込レコード ID |
| **payee_type** | varchar(20) | ✕ | CHECK IN ('Vendor','Affiliate')<br>INDEX(payee_type,payee_id) | 受取主体の種別 |
| **payee_id** | bigint | ✕ | INDEX(payee_type,payee_id) | 受取主体の users.id |
| **period_from** | date | ◯ | | 集計開始日（例：2025-04-01） |
| **period_to** | date | ◯ | | 集計終了日（例：2025-04-30） |
| **gross_amount** | numeric(18,4) | ✕ | DEFAULT 0 | 支払対象額（税抜） |
| **commission_amount** | numeric(18,4) | ✕ | DEFAULT 0 | 手数料控除額 |
| **net_amount** | numeric(18,4) | ✕ | DEFAULT 0 | 実振込額 (= gross − commission) |
| **status** | smallint | ✕ | ActiveHash:`0=pending／1=processing／2=paid／3=failed`<br>DEFAULT 0 | |
| **payout_at** | timestamptz | ◯ | | 実際の振込日時 (`status=paid` でセット) |
| **transaction_ref** | varchar(100) | ◯ | FK → txn.stripe_payouts.payout_id / UNIQUE | 銀行 or 決済 API の取引 ID |
| **bank_name** | varchar(100) | ◯ | | 振込先銀行名（スナップショット） |
| **account_type** | smallint | ◯ | ActiveHash: 0=ordinary 1=checking | 口座種別 |
| **account_number** | varchar(30) | ◯ | | 口座番号（必要ならマスキング） |
| **remarks** | text | ◯ | | 備考・振込失敗理由など |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

`UNIQUE(payee_type,payee_id,period_from,period_to)`

#### メモ
* アフィリエイトの場合、前回集計終了日の翌日から集計し`payouts` に **pending** 行を INSERT
* 加工業者の場合、Stripe 側に合わせる
* 振込 API 成功で `status = paid , payout_at = NOW() , transaction_ref = "BANK1234"` に UPDATE
* 失敗時は `status = failed`, 後で再実行すると新 ID で INSERT し直す

## 通知系

### txn.notifications — 重要ステータス通知・配信履歴

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | 通知レコード ID |
| **recipient_type** | varchar(20) | ✕ | CHECK IN (‘User’,‘Vendor’,‘Admin’,‘Affiliate’)<br>**複合 INDEX①** | 受信者の種別（ポリモーフィック） |
| **recipient_id** | bigint | ✕ | **複合 INDEX①** | 受信者 ID |
| **channel** | smallint | ✕ | ActiveHash: 0=in-app 1=email 2=slack 3=sms | 配信チャネル |
| **notification_type** | varchar(30) | ✕ | INDEX | 通知イベント種別（`order_shipped` など） |
| **subject** | varchar(150) | ◯ | | 件名（メール等） |
| **body** | text | ◯ | | 本文（HTML / Markdown など） |
| **payload_json** | jsonb | ◯ | | 差し込み変数・ボタン URL 等 |
| **related_model_type** | varchar(30) | ◯ | | 関連エンティティ名（`Order` 等） |
| **related_model_id** | bigint | ◯ | INDEX(related_model_type, related_model_id) | 関連レコード ID |
| **status** | smallint | ✕ | ActiveHash: 0=queued 1=sent 2=failed<br>**複合 INDEX①** | 配信ステータス |
| **broadcast_id** | uuid | ◯ | DEFAULT gen_random_uuid() / INDEX | 一斉配信グループ ID（同じメッセージを束ねる） |
| **sent_at** | timestamptz | ◯ | | 実際に送信した日時（status=sent でセット） |
| **read_at** | timestamptz | ◯ | | in-app 通知が既読になった日時 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ

* **複合インデックス①** `IDX_notifications_recipient_status`
  `(recipient_type, recipient_id, status)`
  *大量通知一覧で「受信者ごとの未読/既読を高速検索* & *更新時に行ロック範囲を最小化*。
* `broadcast_id` に単一 INDEX を付与し、**一斉配信の進捗集計** や **既読率算出** を高速化。  
* **送信フロー**  
  1. ビジネスロジックが `status=queued` で INSERT
  1. ジョブワーカーがチャネルごとに送信 → `sent` or `failed` に UPDATE
* **既読管理** は `in_app` チャネルでのみ `read_at` を更新。メールや Slack は NULL のまま。  
* **バルク配信**（例：一斉メンテナンス告知）は recipient ごとに 1 行ずつ INSERT するか、`broadcast_id` 列を追加してグルーピングしても良い。

## ログ系

### h_login_attempts — ログイン成功/失敗・アカウントロック判定

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | |
| user_id | bigint | ◯ | FK→users / INDEX | 対象ユーザー |
| email_tried | varchar(255) | ✕ | | 入力されたメール |
| ip_address | inet | ✕ | INDEX | クライアント IP |
| user_agent | text | ✕ | | UA 文字列 |
| result | smallint | ✕ | 0=success 1=failed 2=locked | 試行結果 |
| created_at | timestamptz | ✕ | **パーティションキー** | 発生日時 |

#### メモ
* sql例
  ```sql
  CREATE TABLE h_login_attempts (
    id bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id bigint,
    email_tried varchar(255) NOT NULL,
    ip_address inet NOT NULL,
    user_agent text NOT NULL,
    result smallint NOT NULL,
    created_at timestamptz NOT NULL
  ) PARTITION BY RANGE (created_at);
  ```

### h_audit_trails — 重要レコードの更新監査

| 列名 | 型 | NULL許可 | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | 監査行 ID |
| table_name | varchar(60) | ✕ | INDEX | 監査対象テーブル名 |
| pk_value | text | ✕ | | 主キー値（複合主キーは JSON 文字列） |
| action | char(1) | ✕ | CHECK IN ('I','U','D') | I=INSERT / U=UPDATE / D=DELETE |
| changed_by | bigint | ◯ | FK→users.id | 操作者（API なら system user） |
| before_json | jsonb | ◯ | | 変更前スナップ（INSERT 時は NULL） |
| after_json | jsonb | ◯ | | 変更後スナップ（DELETE 時は NULL） |
| changed_at | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 変更日時 |

#### メモ

* `before_json / after_json` は、INSERT/DELETE の場合は片方が NULL になる。  
  👉 TRIGGER で **action = 'I' なら before_json=NULL** を保証すると取得時に判定が楽。
* **pk_value を JSONB で持つときのサイズ設計 (≈1 KB 以内)**  
  PK が 3〜4 カラムでも 1 行あたり ～200 B 程度。  
  1 KB 閾値は「設計値の 5 倍」を見込んだ安全弾性です。  
  1 KB 制限を CHECK で保証し、pk_hash インデックスで検索を高速化。
* **“UPDATE / DELETE を全部記録する”――GDPR・J-SOX 遵守のための Audit-trail トリガ実装手順**
  1. **監査テーブル** ― `history.h_audit_trails`
     ```sql
     -- 親テーブル（年別 or 月別パーティション推奨）
     CREATE TABLE history.h_audit_trails (
       id           bigserial PRIMARY KEY,
       table_name   varchar(60) NOT NULL,
       pk_value     text        NOT NULL,
       action       char(1)     NOT NULL CHECK (action IN ('I','U','D')),
       changed_by   bigint,
       before_json  jsonb,
       after_json   jsonb,
       changed_at   timestamptz NOT NULL DEFAULT now()
     ) PARTITION BY RANGE (changed_at);
     ```
     *年別パーティションなら*  
     `FOR VALUES FROM ('2025-01-01') TO ('2026-01-01')`  
     *月別なら* `... 20250501 …` の形式で CREATE します。  

  1. **共通トリガ関数**
     ```sql
     CREATE OR REPLACE FUNCTION history.fn_audit_trail()
     RETURNS trigger AS $$
     DECLARE
       pk text;
     BEGIN
       -- 単一主キー (id) 前提。複合 PK は JSON_BUILD_OBJECT などに変更
       IF TG_OP IN ('INSERT','UPDATE') THEN
         pk := NEW.id::text;
       ELSE
         pk := OLD.id::text;
       END IF;

       INSERT INTO history.h_audit_trails
           (table_name, pk_value, action, changed_by,
            before_json, after_json, changed_at)
       VALUES
           (TG_TABLE_NAME,
            pk,
            substr(TG_OP,1,1), -- 'I','U','D'
            current_setting('app.current_user_id', true)::bigint,
            CASE WHEN TG_OP = 'INSERT' THEN NULL ELSE to_jsonb(OLD) END,
            CASE WHEN TG_OP = 'DELETE' THEN NULL ELSE to_jsonb(NEW) END,
            now());

       RETURN NULL;  -- AFTER ROW なので戻り値は無視
     END;
     $$ LANGUAGE plpgsql;
     ```
     *アプリ側で*
     ```ruby
     ActiveRecord::Base.connection.execute(
       "SELECT set_config('app.current_user_id', #{current_user.id}, false)"
     )
     ```
     としておくと `changed_by` に操作者 ID が入ります。  

  1. **各業務テーブルへ AFTER トリガを追加**  
     例：`txn.orders`
     ```sql
     CREATE TRIGGER trg_audit_orders
     AFTER INSERT OR UPDATE OR DELETE
     ON txn.orders
     FOR EACH ROW
     EXECUTE FUNCTION history.fn_audit_trail();
     ```
     例：`txn.users`
     ```sql
     CREATE TRIGGER trg_audit_users
     AFTER INSERT OR UPDATE OR DELETE
     ON txn.users
     FOR EACH ROW
     EXECUTE FUNCTION history.fn_audit_trail();
     ```
     **ポイント**  
     *INSERT も取る* 理由は「初回登録内容を証跡として残す」ため。  
     INSERT が不要ならトリガのイベントから `INSERT` を外してください。  
  1. **除外する PL/pgSQL トリガの書き方**
     ```sql
     CREATE OR REPLACE FUNCTION tg_h_audit_trails()
     RETURNS trigger LANGUAGE plpgsql AS $$
     DECLARE
       v_pk jsonb;
       v_old jsonb;
       v_new jsonb;
     BEGIN
       /* ❶ 複合 PK → JSONB */
       v_pk := jsonb_build_object(
                 'quote_request_id', COALESCE(OLD.quote_request_id, NEW.quote_request_id),
                 'quote_item_id',    COALESCE(OLD.quote_item_id,  NEW.quote_item_id)
               );

       /* ❷ 旧・新行を JSONB 化しつつ “重い列” を除外 */
       v_old := to_jsonb(OLD) - 'content_blocks' - 'image_urls';
       v_new := to_jsonb(NEW) - 'content_blocks' - 'image_urls';

       /* PostgreSQL 14+ なら行式 + EXCEPT も可 */
       -- v_old := to_jsonb(row_to_json((OLD).* EXCEPT (content_blocks, image_urls)));

       INSERT INTO history.h_audit_trails
             (table_name, pk_value, action, old_data, new_data, changed_at)
       VALUES (TG_TABLE_NAME, v_pk, TG_OP, v_old, v_new, now());

       RETURN NEW;
     END
     $$;

     CREATE TRIGGER audit_quote_request_items
     AFTER INSERT OR UPDATE OR DELETE
     ON txn.quote_request_items
     FOR EACH ROW EXECUTE FUNCTION tg_h_audit_trails();
     ```
  1. **パーティション自動生成（年別例）**
     ```sql
     DO $$
     DECLARE
       start_year int := 2025;
       end_year   int := 2030;
       yr         int;
     BEGIN
       FOR yr IN start_year..end_year LOOP
         EXECUTE format(
           'CREATE TABLE IF NOT EXISTS history.h_audit_trails_%s
              PARTITION OF history.h_audit_trails
              FOR VALUES FROM (''%s-01-01'') TO (''%s-01-01'');',
           yr, yr, yr+1);
       END LOOP;
     END $$;
     ```
     *月別なら `202505` のようにループを調整してください。*  
  
  1. 退避＆削除バッチ（簡易シェル）
     ```bash
     #!/bin/bash
     PGURL="postgresql://app:pass@localhost:5432/appdb"
     ARCHIVE_MONTHS=24
     cutoff=$(date -d "$ARCHIVE_MONTHS months ago" +%Y)

     for part in $(psql "$PGURL" -Atc \
       "SELECT relname FROM pg_class c JOIN pg_namespace n ON n.oid=c.relnamespace
         WHERE n.nspname='history' AND relname ~ 'h_audit_trails_[0-9]{4}'
           AND relname < 'h_audit_trails_${cutoff}';"); do

       echo "Archiving $part"
       pg_dump "$PGURL" -t history.$part | gzip > /tmp/${part}.sql.gz
       aws s3 cp /tmp/${part}.sql.gz s3://audit-archive/
       psql "$PGURL" -c "DROP TABLE history.$part;"
       rm /tmp/${part}.sql.gz
     done
     ```
     cron に毎月1日などで登録すれば「24か月より古い監査パーティションを S3 へ退避 → DROP」できます。  
* **まとめ**
  | 見出し | 内容 |
  | -- | -- |
  | **目的** | 「1 行更新で 100 KB 超が頻発しないよう、`stacktrace` 等は bytea 圧縮 or 除外」 |
  | **トリガ定義** | 上記 `tg_h_audit_trails()` と `CREATE TRIGGER` をコピペ可に |
  | **閲覧方法** | `SELECT convert_from(decompress(stacktrace_compressed),'UTF8') FROM h_error_logs WHERE id=…;` |
  | **サイズ監視** | `pg_total_relation_size('history.h_audit_trails') / pg_size_pretty()` を週次で Datadog 送信 |
  | **パーティション方針** | `PARTITION BY RANGE (changed_at)` 月別、13 ヶ月後に `DETACH + pg_dump` → S3 |

### h_affiliate_clicks — アフィリエイト：クリックログ


| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | クリック行 ID |
| affiliate_user_id | bigint | ✕ | FK→`txn.users.id` (`role = affiliate`) / INDEX | 紹介元アフィリエイトユーザー |
| click_token | uuid | ✕ | UNIQUE | Cookie に保持するトラッキング ID |
| referrer_url | varchar(500) | ◯ | | クリック元ページ |
| landing_url | varchar(500) | ◯ | | 自サイトの着地 URL |
| ip_address | inet | ◯ | | クライアント IP |
| user_agent | varchar(255) | ◯ | | UA 文字列 |
| clicked_at | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | クリック日時 |
| created_at | timestamptz | ✕ | CURRENT_TIMESTAMP | 挿入日時（＝ clicked_at） |

#### メモ
* **目的：** 広告効果測定・不正検知など“重いログ”を切り離す  
* 集計クエリはここを対象にし、報酬確定ロジックは必要な一部だけを affiliate_commissions へ登録する設計。  

### h_payment_webhooks ─ 外部決済 / 銀行 API から受信した Webhook 原本ログ

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | |
| gateway | varchar(30) | ✕ | INDEX | `stripe`, `jpbank` 等 |
| event_id | varchar(255) | ✕ | UNIQUE(gateway,event_id) | 冪等判定キー |
| event_type | varchar(50) | ✕ | INDEX | `charge.succeeded` 等 |
| http_status | smallint | ✕ | | 受信時ステータス |
| signature | varchar(255) | ◯ | | 署名ヘッダ |
| payload_json | jsonb | ✕ | | 受信ボディ (raw) |
| order_id | bigint | ◯ | FK→txn.orders / INDEX | 関連注文 |
| payout_id | bigint | ◯ | FK→txn.payouts / INDEX | 関連振込 |
| processed_at | timestamptz | ◯ | | アプリ処理完了日時 |
| processing_result | smallint | ◯ | 0=ok 1=ignored 2=error | |
| created_at | timestamptz | ✕ | **パーティションキー** | 受信日時 |

#### メモ
* sql  
  ```sql
  CREATE TABLE h_payment_webhooks (
    id bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    gateway varchar(30) NOT NULL,
    event_id varchar(100) NOT NULL,
    event_type varchar(50) NOT NULL,
    http_status smallint NOT NULL,
    signature varchar(255),
    payload_json jsonb NOT NULL,
    order_id bigint,
    payout_id bigint,
    processed_at timestamptz,
    processing_result smallint,
    created_at timestamptz NOT NULL,
    UNIQUE (gateway, event_id)
  ) PARTITION BY RANGE (created_at);
  ```
* *INSERT-only* テーブル。誤っても UPDATE/DELETE しないのが原則。

###  h_payout_events ─ 振込レコード (`txn.payouts`) の内部ライフサイクルイベント

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | |
| **payout_id** | bigint | ✕ | FK → txn.payouts.id / INDEX | 関連する振込ヘッダ |
| **event** | varchar(30) | ✕ | INDEX | `queued` `send_api` `paid` `failed` `retry`…<br>業務フローで定義 |
| **meta_json** | jsonb | ◯ | — | 失敗理由・リトライ回数など付随情報 |
| **occurred_at** | timestamptz | ✕ | — | イベント発生日時 |
| **logged_by_type** | varchar(20) | ◯ | CHECK IN ('System','User','Admin') | 生成主体 |
| **logged_by_id** | bigint | ◯ | INDEX(logged_by_type, logged_by_id) | 発生主体 ID（バッチ= NULL） |
| **created_at** | timestamptz | ✕ | — | レコード作成日時（＝ occurred_at と同値が基本） |

#### メモ
  * **INSERT-only** だが、社内オペミス修正を許す場合は `meta_json` の UPDATE を許容しても可。
  * `event` を (`master.payout_event_types`) しておくと SQL 集計・BI が楽。

### h_article_views ─ `views_count` 更新集計元テーブル

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint (AI) | ✕ | **PK** | 行 ID |
| article_id | bigint | ✕ | FK → txn.articles / INDEX | 閲覧記事 |
| user_id | bigint | ◯ | FK → users / INDEX | ログイン閲覧者（匿名は NULL） |
| ip_address | inet | ◯ | | クライアント IP |
| viewed_at | timestamptz | ✕ | **パーティションキー** | 閲覧日時 |
| ua_hash | char(32) | ◯ | | UA を MD5 縮約（任意） |
| **processed_flag** | boolean | ✕ | DEFAULT false<br>**部分 INDEX** ¹ | 未集計＝false／集計済＝true |
| created_at | timestamptz | ✕ | DEFAULT now() | 挿入日時 (= viewed_at) |

#### メモ
* ¹ `idx_article_views_unprocessed (article_id) WHERE processed_flag=false`  
   ──ジョブはこのインデックスだけを掃くので高速。
* **集計の概念フロー**（10 秒ごとなど）
  1. **未処理行を取得**  
     `WHERE processed_flag = false AND viewed_at ≤ now()`
  1. **記事ごと集計 → txn.articles.views_count に加算**  
  1. **対象行を `processed_flag = true` に更新**  
  （同一トランザクション内で実施すると二重カウントを防げる）
  1. **古い true 行は年次バッチで DELETE + VACUUM**  
  → テーブル肥大を抑制

* **集計方式**: “processed flag” を採用。  
  *INSERT は常時書き込みオンリー／UPDATE は集計バッチのみ。*  
  * **未処理インデックス `idx_article_views_unprocessed` を利用**  
  * 集計ジョブ
    ```sql
    WITH v AS (
      SELECT article_id, COUNT(*) AS c
        FROM history.h_article_views
       WHERE processed_flag = false
       GROUP BY article_id
    )
    UPDATE txn.articles a
       SET views_count = views_count + v.c
      FROM v
     WHERE a.id = v.article_id;

    UPDATE history.h_article_views
       SET processed_flag = true
     WHERE processed_flag = false;
    ```
    *行ロック競合はほぼ発生しません* (INSERT-only テーブル＋一括 UPDATE)。
    テーブルが月を跨いで巨大になる前に **月毎パーティション**を導入するか、一定期間で **ARCHIVE & DROP** する運用を推奨。

### h_error_logs — アプリ例外 / 500 エラー圧縮スタック対応・月別パーティション前提

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **id** | bigint | ✕ | **PK** / AUTO_INCREMENT | ログ行 ID |
| error_class | varchar(120) | ✕ | INDEX | 例：`ActiveRecord::RecordNotFound` |
| message | text | ✕ | | 例外メッセージ（先頭だけでも可） |
| **stacktrace** | **bytea** | ✕ | | gzip（＋任意暗号化）済みフルバックトレース |
| stack_head | text | ◯ | | 先頭 1 KB を平⽂で保存し一覧確認を高速化（任意） |
| request_path | varchar(255) | ◯ | INDEX | 発生 URL `/orders/123` など |
| http_method | char(6) | ◯ | | `GET`,`POST` … |
| status_code | smallint | ✕ | DEFAULT 500 | 返却 HTTP ステータス |
| params_json | jsonb | ◯ | | リクエストパラメータ（マスク済） |
| user_id | bigint | ◯ | FK→users.id / INDEX | 発生ユーザー（未ログインは NULL） |
| request_id | char(36) | ◯ | INDEX | X-Request-ID |
| ip_address | inet | ◯ | | クライアント IP |
| user_agent | varchar(255) | ◯ | | UA 文字列 |
| server_name | varchar(60) | ◯ | | Pod/EC2 ホスト名 |
| environment | char(10) | ✕ | CHECK IN ('prod','stg','dev') | Rails 環境 |
| occurred_at | timestamptz | ✕ | | 例外発生日時 |
| created_at | timestamptz | ✕ | | INSERT日時（通常＝occurred_at） |

#### メモ

* BEFORE INSERT トリガで `compress()`（+ `pgp_sym_encrypt` も可）を適用。  
* cron で **6 か月より古いパーティションを** `pg_dump | gzip | aws s3 cp` → **DROP** し、DB bloat を抑止。  
* 例：  
  **history.h_error_logs 圧縮トリガ**
  ```sql
  -- ❶ pgcrypto の compress() / decompress() を利用
  CREATE FUNCTION h_error_logs_before_ins()  -- ★README に載せるサンプル
  RETURNS trigger LANGUAGE plpgsql AS $$
  BEGIN
    -- 元 stacktrace は text 列で受け、bytea 列へ自動圧縮
    NEW.stacktrace_compressed := compress(NEW.stacktrace);  -- ← bytea
    NEW.stacktrace            := NULL;                      -- 不要なら消す
    RETURN NEW;
  END
  $$;

  CREATE TRIGGER trg_h_error_logs_compress
  BEFORE INSERT ON history.h_error_logs
  FOR EACH ROW EXECUTE FUNCTION h_error_logs_before_ins();
  ```
  **展開**
  ```sql
  SELECT 
    id,
    convert_from(decompress(stacktrace_compressed), 'UTF8') AS stacktrace
  FROM history.h_error_logs
  WHERE id = :target_id;
  ```
* まとめ
  | セクション | 記載例 |
  | -- | -- |
  | **目的** | 「stacktrace は長いので圧縮 bytea 化し、テーブル肥大を抑制」 |
  | **トリガ DDL** | 上記 `CREATE FUNCTION` / `CREATE TRIGGER` |
  | **展開方法** | `SELECT convert_from(decompress(...))` の SQL |
  | **BLEVE / Grafana 等の APM 連携** | ログ集約時は `decompress()` して別ストリームへ転送 |
  | **運用 Tips** | `ALTER TABLE … DETACH PARTITION …` で月別パーティション<br>古い月は `pg_dump -Fc` → S3 アーカイブ |

## マスタ系

### m_authorities — 権限マスタ

| 列名 | 型 | NULL許可 | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | varchar(30) | ✕ | **PK** | 権限コード（`QUOTE_EDIT` など） |
| name_ja | varchar(60) | ✕ | | 権限名（日本語） |
| default_roles | jsonb | ◯ | | 権限を自動付与するロール配列<br>`["admin"]` など |
| active_flag | boolean | ✕ | DEFAULT true | 無効化すると新規付与不可 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_prefectures ― 都道府県マスタ（JIS X 0401 準拠）

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| code | char(2) | ✕ | **PK** / CHECK `01–47` | JIS X 0401 都道府県コード |
| name_ja | varchar(10) | ✕ | UNIQUE | 漢字（北海道…沖縄） |
| name_en | varchar(20) | ✕ | | ISO 3166-2 原文 (Aichi, Tokyo…) |
| kana | varchar(20) | ✕ | | 全角カナ（ホッカイドウ…）<br>※半角カナが必要なら列追加 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_cities ― 市区町村マスタ（JIS X 0402 準拠）

| 列名 | 型 | NULL許可 | 制約・インデックス | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(5) | ✕ | **PK** | JIS 市区町村コード（例 `13113` 渋谷区） |
| prefecture_code | char(2) | ✕ | FK→`m_prefectures.code` / INDEX | 所属都道府県 |
| name_ja | varchar(100) | ✕ | | 名称（日本語） |
| name_kana | varchar(100) | ◯ | | 名称かな |
| name_en | varchar(100) | ◯ | | ローマ字（任意） |
| sort_no | smallint | ◯ | | 表示順 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ  
* *データは総務省 CSV（市区町村コード一覧）をロードすれば約 1,900 行程度。*

### m_process_categories ― 加工方法カテゴリマスタ

| 列名 | 型 | NULL許可 | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(10) | ✕ | **PK** | `WOOD`, `METAL`, … |
| name_ja | varchar(20) | ✕ | UNIQUE | 木材, 金属, 樹脂 … |
| name_en | varchar(20) | ✕ | | Wood, Metal … |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* 当面はcode:`WOOD`のみで運用。
* 将来 `METAL`, `PLST` など追加

### m_process_types ― 加工方法詳細マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(10) | ✕ | **PK** | `WOOD-COR` (角加工), `WOOD-RH` (丸穴), `WOOD-SH` (四角穴)… |
| category_code | char(6) | ✕ | FK → m_process_categories.code | |
| name_ja | varchar(40) | ✕ | | |
| name_en | varchar(40) | ✕ | | |
| jis_iso | varchar(12) | ◯ | | 必要なら JIS B0126 番号 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_material_categories ― 材質カテゴリマスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(10) | ✕ | **PK** | `WOOD`, `METAL`, … |
| name_ja | varchar(20) | ✕ | UNIQUE | 木材, 金属, 樹脂 … |
| name_en | varchar(20) | ✕ | | Wood, Metal … |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_materials ― 材質詳細マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(16) | ✕ | **PK** | `WOOD-REDPINE`, `METAL-AL5052`… |
| category_code | char(6) | ✕ | FK → m_material_categories.code / INDEX | 大分類 |
| name_ja | varchar(40) | ✕ | | アカマツ, A5052 … |
| name_en | varchar(40) | ✕ | | Red Pine, Aluminum 5052 |
| description\_ja | varchar(80) | ◯ | | 詳細説明 |
| description\_en | varchar(80) | ◯ | | 詳細説明 |
| jis_iso | varchar(12) | ◯ | | 金属系なら `JIS H4000` など |
| density_kg_per_m3 | numeric(8,2) | ✕ | | 単位質量（kg／m³） |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* 重量計算スニペット  
   ```ruby
   weight = if material.density_kg_per_m3.present?
              volume_m3 * material.density_kg_per_m3
            else
              nil   # or raise validation error
            end
   ```

### m_shapes ― 平面形状マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(10) | ✕ | **PK** | 平面形状コード（`RECT`,`TRAP`,`CIRCLE`…） |
| name\_ja | varchar(30) | ✕ | UNIQUE | 日本語名（四角形、台形…） |
| name\_en | varchar(30) | ✕ | UNIQUE | 英語名 (Rectangle, Trapezoid…) |
| description\_ja | varchar(80) | ◯ | | 詳細説明 |
| description\_en | varchar(80) | ◯ | | 詳細説明 |
| allow\_shape\_json | text[] | ✕ | DEFAULT '{}' | **shape\_json** で加工設定を入力できる個所 ["tl","tr","bl","br"] など |
| allow\_corner\_json | text[] | ✕ | DEFAULT '{}' | **corner\_proc\_json** でコーナー加工が可能な個所 ["tl","tr","bl","br"] など |
| allow_edge_json | text[] | ✕ | DEFAULT '{}' | **edge\_json** で断面加工が可能な個所 ["tl","tr","bl","br"] など |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* sql
   ```sql
   -- 列定義例
   allow_corner_pos text[]  -- NOT NULL DEFAULT '{}'

   -- 角丸め可能か？
   WHERE 'tl' = ANY(allow_corner_pos);
   ```

### m_paint_types ― 塗装種類マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(10) | ✕ | **PK** | 塗装種類コード |
| name\_ja | varchar(30) | ✕ | UNIQUE | 日本語名 (選択なし・ウレタン・自然塗装…) |
| name\_en | varchar(30) | ✕ | UNIQUE | 英語名 |
| description\_ja | varchar(80) | ◯ | | 詳細説明 |
| description\_en | varchar(80) | ◯ | | 詳細説明 |
| allow\_paint\_json | text[] | ✕ | DEFAULT '{}' | **paint\_json** で塗装設定を入力できる個所 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_corner_processes ― コーナー加工マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(10) | ✕ | **PK** | コーナー加工コード（`NONE`,`ROUND`,`CHMFR` …） |
| name\_ja | varchar(30) | ✕ | UNIQUE | 日本語名（なし／角丸め／面取り …） |
| name\_en | varchar(30) | ✕ | UNIQUE | 英語名 (None, Round, Chamfer …) |
| description\_ja | varchar(80) | ◯ | | 詳細説明 |
| description\_en | varchar(80) | ◯ | | 詳細説明 |
| allow_corner_proc_json | text[] | ✕ | DEFAULT '{}' | **corner_proc_json** で設定を入力できる個所 `dx`, `dy`, `r`|
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

#### メモ
* **ユースケース**  
   `corner_proc_json = { "tl":{ "proc":"CHMFR","dx":5,"dy":5 }, "tr":{"proc":"ROUND","r":3}, … }`  
   `txn.quote_items` 側では **コード値のみ** を保持し、表示時に `m_corner_processes` へ JOIN してラベルを得る。  
* マスタ側で `code` **値を変更することは基本禁止**（新コードを追加し旧コードを非推奨に）。  
   もしどうしても置換が必要なら  
   ```sql
   UPDATE txn.quote_items
      SET corner_proc_json =
          jsonb_set(corner_proc_json,'{tl,proc}','"ROND2"',false)
    WHERE corner_proc_json @> '{"tl":{"proc":"ROUND"}}';
   ```
   のように一括 UPDATE が可能。GIN インデックス付きでも更新コストは許容範囲です。

### m_hole_diameters ― 丸穴直径マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(10) | ✕ | **PK** | `1mm`, `3mm`… |
| hole_mm | decimal(8,2) | ✕ | | 実寸 |
| name_ja | varchar(20) | ✕ | | `１ミリメートル`, `３ミリメートル`… |
| name_en | varchar(6) | ✕ | | `1mm`, `3mm`… |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_edge_processes ― 断面加工マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(10) | ✕ | **PK** | 断面加工コード(`NONE`, `BEVEL`…) |
| name_ja | varchar(20) | ✕ | | `断面加工なし`, `上下糸面`… |
| name_en | varchar(6) | ✕ | | |
| description\_ja | varchar(80) | ◯ | | 詳細説明 |
| description\_en | varchar(80) | ◯ | | 詳細説明 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_paint_surfaces ― 塗装面マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(6) | ✕ | **PK** | 塗装面コード |
| name\_ja | varchar(30) | ✕ | UNIQUE | 標準、全面 … |
| name\_en | varchar(30) | ✕ | UNIQUE | |
| description\_ja | varchar(80) | ◯ | | 詳細説明 |
| description\_en | varchar(80) | ◯ | | 詳細説明 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_paint_colors ― 塗装色マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(6) | ✕ | **PK** | 塗装色コード |
| name\_ja | varchar(30) | ✕ | UNIQUE | クリアー・ライト… |
| name\_en | varchar(30) | ✕ | UNIQUE | |
| description\_ja | varchar(80) | ◯ | | 詳細説明 |
| description\_en | varchar(80) | ◯ | | 詳細説明 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_grain_finishes ― 木目仕上げマスタ  

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(6) | ✕ | **PK** | `SEMIOP`, `CLOSE`, `OPEN` … |
| name\_ja | varchar(30) | ✕ | UNIQUE | セミオープン塗装、クローズ塗装 … |
| name\_en | varchar(30) | ✕ | UNIQUE | Semi-open, Close … |
| description\_ja | varchar(80) | ◯ | | 詳細説明 |
| description\_en | varchar(80) | ◯ | | 詳細説明 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |

### m_glosses ― ツヤ（光沢度）マスタ

| 列名 | 型 | NULL | 制約 | 説明 |
| -- | -- | -- | -- | -- |
| **code** | char(6) | ✕ | **PK** | ツヤコード（`GLOSS3`, `GLOSS5`, `FULL` …） |
| name\_ja | varchar(30) | ✕ | UNIQUE | 日本語名（3 分ツヤ、5 分ツヤ、全ツヤ …） |
| name\_en | varchar(30) | ✕ | UNIQUE | 英語名 (30 % Gloss, 50 % Gloss, Full Gloss …) |
| gloss\_pct | smallint | ✕ | CHECK BETWEEN 0 AND 100 | 光沢度 (%) を数値で保持 <br>例：3 分ツヤ → 30 |
| description\_ja | varchar(80) | ◯ | | 詳細説明・備考 |
| description\_en | varchar(80) | ◯ | | 詳細説明・備考 |
| **created_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | レコード作成日時 |
| **created_by_id** | bigint | ◯ | FK → users.id | レコード作成者 |
| **updated_at** | timestamptz | ✕ | DEFAULT CURRENT_TIMESTAMP | 最終更新日時 |
| **updated_by_id** | bigint | ◯ | FK → users.id | 最終更新者 |
| **deleted_flag** | boolean | ✕ | DEFAULT false | 論理削除フラグ（true = 無効） |
| **deleted_at** | timestamptz | ◯ | | 削除日時 |
| **deleted_by_id** | bigint | ◯ | FK → users.id | 削除実行者 |
